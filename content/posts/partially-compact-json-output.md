+++
title = "jqでpretty-printしたJSONの一部をコンパクトに出力する"
date = 2024-12-24T18:08:10+09:00
lastmod = 2024-12-24T18:08:10+09:00
draft = false
description = ""
summary = ""
categories = ["雑記"]
tags = ["jq", "json"]
+++

以下のような長めの配列を含むJSONがほしい場合、

```json
{
  "odd": [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31],
  "even": [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30]
}
```

[`jq`](https://jqlang.github.io/jq/)でpretty-printすると配列が要素ごとに改行されます。

```sh
$ echo '{"odd":[1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31],"even":[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30]}' | jq
{
  "odd": [
    1,
    3,
    5,
    7,
    9,
    11,
    13,
    15,
    17,
    19,
    21,
    23,
    25,
    27,
    29,
    31
  ],
  "even": [
    0,
    2,
    4,
    6,
    8,
    10,
    12,
    14,
    16,
    18,
    20,
    22,
    24,
    26,
    28,
    30
  ]
}
```

このような出力だと大きなJSONファイルのときは行数が膨大になって扱いにくいと思います。
私が最近作った[Camellia](https://info.isl.ntt.co.jp/crypt/camellia/)の[Zig](https://ziglang.org/)実装の[camellia-zig](https://github.com/sorairolake/camellia-zig)ではテストベクターにJSONファイルを使っていますが、配列が要素ごとに改行された結果、5万行近いJSONファイルになって困っていました。
コンパクト出力を使えば行数は減らせますが、全体がコンパクト出力になるのは望んでいませんでした。
上記の問題を解決したかったので、最初の例のように配列を要素ごとに改行しないで出力する方法を調べました。

## 方法

[jqlang/jq#643のコメント](https://github.com/jqlang/jq/issues/643#issuecomment-392640310)の[ddopson/underscore-cli](https://github.com/ddopson/underscore-cli)を使う方法で最初の例のように出力できました。

```sh
$ echo '{"odd":[1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31],"even":[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30]}' | jq | npx underscore pretty --outfmt json
{
  "odd": [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31],
  "even": [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30]
}
```

この方法でテストベクターファイルの行数を5,000行程度まで減らすことができました。

## 終わりに

もっと良い方法があったら教えてもらえると嬉しいです。
